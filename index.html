<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raju da dhabba - Order App</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Poppins and Inter from Google Fonts for a professional look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    
    <style>
        /* Custom styles for mobile-first design */
        body {
            font-family: 'Inter', sans-serif; 
            background-color: #f7f3e8; 
            min-height: 100vh;
        }
        #app {
            max-width: 500px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            background-color: #ffffff;
        }
        
        /* --- Gradients and Animations --- */
        @keyframes pulse-once {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(49, 46, 129, 0.4); }
            70% { transform: scale(1.02); box-shadow: 0 0 0 15px rgba(49, 46, 129, 0); }
            100% { transform: scale(1); box-shadow: 0 8px 15px -3px rgb(0 0 0 / 0.2); }
        }

        .cta-pulse {
            animation: pulse-once 1.5s ease-out 1;
        }

        @keyframes bounce-in {
            0% { transform: scale(0.5); opacity: 0; }
            60% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: #312e81; 
            animation: spin 1s linear infinite;
        }

        .header-style {
            background-color: #312e81; 
            background-image: linear-gradient(to right bottom, #4f46e5, #312e81);
            color: white;
            padding: 1rem 0;
            text-align: center;
            font-size: 1.8rem;
            font-weight: 700;
            border-bottom-left-radius: 1rem;
            border-bottom-right-radius: 1rem;
            letter-spacing: 0.05em;
            font-family: 'Poppins', sans-serif; 
        }
        
        @keyframes fadeInSlideUp {
            0% { opacity: 0; transform: translateY(10px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        .menu-item-animate {
            animation: fadeInSlideUp 0.3s ease-out;
            animation-fill-mode: both; 
        }
        
        .item-container:not(:last-child) {
            border-bottom: 1px solid #e5e7eb;
        }
        .quantity-btn {
            background-color: #f3f4f6;
            transition: background-color 0.1s;
        }
        .quantity-btn:hover {
            background-color: #e5e7eb;
        }
        .active-tab {
            background-color: #312e81; 
            color: white;
            border-radius: 9999px;
            box-shadow: 0 4px 8px -2px rgb(0 0 0 / 0.2);
        }
    </style>
</head>
<body class="p-0 m-0">

    <div id="app" class="relative">
        <!-- Application content will be injected here -->
    </div>

    <script>
        // --- Configuration ---
        const WEBSCREEN_ID = 'app';
        // UPDATED WEBHOOK URL
        const WEBHOOK_URL = 'https://n8n.srv1234891.hstgr.cloud/webhook/Menu'; 
        const HOTEL_NAME = 'Raju da dhabba';

        // --- Menu Data ---
        const GITHUB_RAW_BASE = "https://raw.githubusercontent.com/kaushalborse38-maker/helpmeorder/main/";

        const menu = {
            Starter: [
                { 
                    id: 101, 
                    name: "Paneer Tikka", 
                    price: 280, 
                    description: "Smoky cottage cheese cubes", 
                    image: GITHUB_RAW_BASE + "Paneer%20Tikka.jpeg" 
                },
                { 
                    id: 102, 
                    name: "Crispy Corn", 
                    price: 220, 
                    description: "Fried corn kernels with spices", 
                    image: GITHUB_RAW_BASE + "Crispy%20Corn.jpeg" 
                },
                { 
                    id: 103, 
                    name: "Veg. Spring Rolls", 
                    price: 180, 
                    description: "Crispy veggie rolls", 
                    image: GITHUB_RAW_BASE + "download.jpeg" 
                },
            ],
            Maincourse: [
                { 
                    id: 201, 
                    name: "Dal Makhani", 
                    price: 350, 
                    description: "Creamy black lentil curry", 
                    image: GITHUB_RAW_BASE + "Dal%20Makhani.jpeg" 
                },
                { 
                    id: 202, 
                    name: "Shahi Paneer", 
                    price: 420, 
                    description: "Royal cottage cheese preparation", 
                    image: GITHUB_RAW_BASE + "Shahi%20Paneer.jpeg" 
                },
                { 
                    id: 203, 
                    name: "Butter Naan", 
                    price: 70, 
                    description: "Leavened flatbread with butter", 
                    image: GITHUB_RAW_BASE + "Butter%20Naan.jpeg" 
                },
                { 
                    id: 204, 
                    name: "Jeera Rice", 
                    price: 150, 
                    description: "Rice tempered with cumin", 
                    image: GITHUB_RAW_BASE + "Jeera%20Rice.jpeg" 
                },
            ],
            Drinks: [
                { 
                    id: 301, 
                    name: "Masala Chaas", 
                    price: 90, 
                    description: "Spiced buttermilk", 
                    image: GITHUB_RAW_BASE + "Masala%20Chaas.jpeg" 
                },
                { 
                    id: 302, 
                    name: "Fresh Lime Soda", 
                    price: 120, 
                    description: "Sweet/Salty refreshing drink", 
                    image: GITHUB_RAW_BASE + "Fresh%20Lime%20Soda.jpeg" 
                },
                { 
                    id: 303, 
                    name: "Water Bottle", 
                    price: 40, 
                    description: "1 litre mineral water", 
                    image: GITHUB_RAW_BASE + "Water%20Bottle.jpeg" 
                },
            ],
            Sweet: [
                { 
                    id: 401, 
                    name: "Gulab Jamun (2pcs)", 
                    price: 150, 
                    description: "Deep-fried milk solids in sugar syrup", 
                    image: GITHUB_RAW_BASE + "Gulab%20Jamun%20(2pcs).jpeg" 
                },
                { 
                    id: 402, 
                    name: "Gajar Halwa", 
                    price: 200, 
                    description: "Carrot pudding", 
                    image: GITHUB_RAW_BASE + "Gajar%20Halwa.jpeg" 
                },
            ],
        };

        // --- Application State ---
        let cart = {};
        let currentCategory = 'Starter';
        let customerDetails = {
            name: '',
            contact: '',
            tableNumber: '',
            instructions: ''
        };

        // --- Utility Functions ---

        function renderScreen(contentHtml) {
            const appElement = document.getElementById(WEBSCREEN_ID);
            appElement.innerHTML = contentHtml;
        }

        function calculateTotal() {
            let total = 0;
            const orderedItems = [];

            for (const category in menu) {
                menu[category].forEach(item => {
                    const quantity = cart[item.id] || 0;
                    if (quantity > 0) {
                        const itemTotal = item.price * quantity;
                        total += itemTotal;
                        orderedItems.push({
                            itemId: item.id,
                            name: item.name,
                            price: item.price,
                            quantity: quantity,
                            subtotal: itemTotal
                        });
                    }
                });
            }
            return { total, items: orderedItems };
        }

        // --- Screen Implementations ---

        function showWelcomeScreen() {
            const html = `
                <div class="flex-grow flex flex-col justify-center items-center p-8 text-center bg-gray-50">
                    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm">
                        <svg class="w-20 h-20 text-orange-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                        <h1 class="text-4xl font-extrabold text-gray-900 tracking-tight mb-2 font-['Poppins']">
                            ${HOTEL_NAME}
                        </h1>
                        <p class="text-gray-600 mb-8 italic">
                            Authentic Indian Cuisine, Made with Love.
                        </p>
                        <button onclick="showMenuScreen()" 
                                class="w-full py-3 px-6 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-full shadow-lg transform transition duration-150 hover:scale-[1.02] active:scale-[0.98] font-['Poppins'] cta-pulse">
                            Start Ordering
                        </button>
                    </div>
                </div>
            `;
            renderScreen(html);
        }

        function showMenuScreen() {
            const menuHtml = menu[currentCategory].map((item, index) => `
                <div class="item-container flex items-center p-4 hover:bg-gray-50 transition duration-100 menu-item-animate" style="animation-delay: ${index * 0.05}s;">
                    
                    <div class="flex-shrink-0 mr-4">
                        <img src="${item.image}" alt="${item.name}" 
                             class="w-16 h-16 object-cover rounded-lg shadow-md border border-gray-100" 
                             onerror="this.onerror=null; this.src='https://placehold.co/64x64/E5E7EB/9CA3AF?text=Food'" />
                    </div>

                    <div class="flex-1 min-w-0 pr-3">
                        <p class="text-lg font-semibold text-gray-800 truncate">${item.name}</p>
                        <p class="text-sm text-gray-500 truncate">${item.description}</p>
                        <p class="text-base font-bold text-green-600">₹${item.price}</p>
                    </div>

                    <div class="flex items-center space-x-2 border border-gray-300 rounded-full flex-shrink-0">
                        <button onclick="updateQuantity(${item.id}, -1)" 
                                class="quantity-btn w-8 h-8 flex items-center justify-center rounded-full text-lg font-bold text-red-500 shadow-sm active:shadow-none">
                            -
                        </button>
                        <span id="qty-${item.id}" class="w-6 text-center text-gray-800 font-medium text-sm">
                            ${cart[item.id] || 0}
                        </span>
                        <button onclick="updateQuantity(${item.id}, 1)" 
                                class="quantity-btn w-8 h-8 flex items-center justify-center rounded-full text-lg font-bold text-green-500 shadow-sm active:shadow-none">
                            +
                        </button>
                    </div>
                </div>
            `).join('');

            const categoryTabs = Object.keys(menu).map(cat => `
                <button onclick="changeCategory('${cat}')" 
                        class="p-2 px-4 text-sm font-medium transition duration-150 whitespace-nowrap font-['Poppins'] ${currentCategory === cat ? 'active-tab' : 'text-gray-700 hover:bg-gray-100 rounded-full'}">
                    ${cat}
                </button>
            `).join('');

            const totalInfo = calculateTotal();
            const doneButtonClasses = totalInfo.total > 0 ? 
                'bg-orange-500 hover:bg-orange-600 shadow-md hover:shadow-lg' : 
                'bg-gray-400 cursor-not-allowed shadow-none';

            const html = `
                <header class="sticky top-0 z-10 header-style p-4">
                    <h2 class="text-2xl">${HOTEL_NAME} Menu</h2>
                </header>

                <div class="sticky top-[4.5rem] z-10 bg-white shadow-md overflow-x-auto p-3 flex space-x-3">
                    ${categoryTabs}
                </div>

                <div class="flex-grow overflow-y-auto pb-20">
                    ${menuHtml}
                </div>

                <footer class="sticky bottom-0 bg-white p-4 shadow-2xl border-t-2 border-gray-100">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-gray-700 font-semibold">Order Total:</span>
                        <span id="menu-total" class="text-2xl font-extrabold text-indigo-600 font-['Poppins']">
                            ₹${totalInfo.total}
                        </span>
                    </div>
                    <button id="done-ordering-btn" 
                            onclick="if(calculateTotal().total > 0) showDetailsScreen()" 
                            class="w-full py-3 text-white font-bold rounded-xl transform transition duration-150 font-['Poppins'] ${doneButtonClasses}">
                        Done Ordering (${totalInfo.items.length} items)
                    </button>
                </footer>
            `;
            renderScreen(html);
        }

        function changeCategory(newCategory) {
            currentCategory = newCategory;
            showMenuScreen();
        }

        function updateQuantity(itemId, delta) {
            const currentQty = cart[itemId] || 0;
            const newQty = Math.max(0, currentQty + delta);
            cart[itemId] = newQty;
            
            const qtySpan = document.getElementById(`qty-${itemId}`);
            if (qtySpan) {
                qtySpan.textContent = newQty;
            }

            const totalInfo = calculateTotal();
            const totalSpan = document.getElementById('menu-total');
            if (totalSpan) {
                totalSpan.textContent = `₹${totalInfo.total}`;
            }

            const doneBtn = document.getElementById('done-ordering-btn');
            if (doneBtn) {
                const buttonColor = totalInfo.total > 0 ? 'bg-orange-500 hover:bg-orange-600 shadow-md hover:shadow-lg' : 'bg-gray-400 cursor-not-allowed shadow-none';
                doneBtn.className = `w-full py-3 text-white font-bold rounded-xl transform transition duration-150 font-['Poppins'] ${buttonColor}`;
                doneBtn.textContent = `Done Ordering (${totalInfo.items.length} items)`;
            }
        }

        function showDetailsScreen() {
            const totalInfo = calculateTotal();
            const summaryHtml = totalInfo.items.map(item => `
                <li class="flex justify-between text-base py-1 border-b border-dashed border-gray-200">
                    <span class="font-medium text-gray-700">${item.name} <span class="text-sm text-indigo-500">(x${item.quantity})</span></span>
                    <span class="font-semibold text-gray-900">₹${item.subtotal}</span>
                </li>
            `).join('');

            const html = `
                <header class="header-style p-4 flex items-center">
                    <button onclick="showMenuScreen()" class="text-white mr-4 text-2xl p-1 rounded-full hover:bg-white/10 transition">
                        &larr;
                    </button>
                    <h2 class="text-xl flex-grow text-left font-['Poppins']">Order Confirmation</h2>
                </header>

                <div class="p-5 flex-grow overflow-y-auto">
                    <div class="bg-white p-4 rounded-xl shadow-lg border-2 border-indigo-100 mb-6">
                        <h3 class="text-xl font-bold text-indigo-700 mb-3 font-['Poppins']">Your Order Summary</h3>
                        <ul class="space-y-1 mb-3">
                            ${summaryHtml}
                        </ul>
                        <div class="flex justify-between items-center pt-3 border-t-2 border-indigo-200">
                            <span class="text-lg font-bold text-gray-800 font-['Poppins']">Grand Total:</span>
                            <span class="text-3xl font-extrabold text-green-600 font-['Poppins']">₹${totalInfo.total}</span>
                        </div>
                    </div>

                    <h3 class="text-xl font-bold text-gray-800 mb-4 font-['Poppins']">Your Details</h3>
                    <form id="detailsForm" class="space-y-4">
                        <div>
                            <label for="name" class="block text-sm font-medium text-gray-700">Name (Mandatory)</label>
                            <input type="text" id="name" required placeholder="Enter your full name" value="${customerDetails.name}"
                                class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 border" />
                        </div>
                        <div>
                            <label for="contact" class="block text-sm font-medium text-gray-700">Contact Number (Mandatory)</label>
                            <input type="tel" id="contact" required placeholder="10-digit mobile number" value="${customerDetails.contact}"
                                class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 border" pattern="[0-9]{10,12}" title="Please enter a valid contact number"/>
                        </div>
                        <div>
                            <label for="tableNumber" class="block text-sm font-medium text-gray-700">Table Number (Mandatory)</label>
                            <input type="number" id="tableNumber" required placeholder="e.g., 5" value="${customerDetails.tableNumber}"
                                class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 border" min="1" max="999" />
                        </div>
                        <div>
                            <label for="instructions" class="block text-sm font-medium text-gray-700">Instructions for Kitchen (Optional)</label>
                            <textarea id="instructions" placeholder="e.g., Make it extra spicy, No onion/garlic" 
                                class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 border h-20">${customerDetails.instructions}</textarea>
                        </div>
                    </form>
                </div>

                <footer class="sticky bottom-0 bg-white p-4 shadow-2xl border-t-2 border-gray-100">
                    <button onclick="submitOrder()" 
                            class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl shadow-lg transform transition duration-150 hover:scale-[1.01] active:scale-[0.99] font-['Poppins']">
                        Place Order & Pay Total: ₹${totalInfo.total}
                    </button>
                </footer>
            `;
            renderScreen(html);
        }

        async function submitOrder() {
            const form = document.getElementById('detailsForm');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            customerDetails = {
                name: document.getElementById('name').value,
                contact: document.getElementById('contact').value,
                tableNumber: document.getElementById('tableNumber').value,
                instructions: document.getElementById('instructions').value
            };

            const orderData = calculateTotal();

            const payload = {
                hotelName: HOTEL_NAME,
                timestamp: new Date().toISOString(),
                customer: customerDetails,
                order: orderData.items,
                grandTotal: orderData.total
            };

            document.getElementById(WEBSCREEN_ID).innerHTML = `
                <div class="flex-grow flex flex-col justify-center items-center p-8 text-center">
                    <div class="spinner mb-6"></div> 
                    <p class="text-xl font-semibold text-gray-700 mt-4 font-['Poppins']">Processing Order...</p>
                    <p class="text-gray-500">Sending order data, please wait securely.</p>
                </div>
            `;
            
            let success = false;
            let errorMessage = '';

            try {
                const response = await fetchWithRetry(WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }, 3);

                if (response.ok) {
                    success = true;
                } else {
                    errorMessage = `Webhook failed with status: ${response.status} ${response.statusText}`;
                }
            } catch (error) {
                errorMessage = `Network or fetch error: ${error.message}`;
            }

            if (success) {
                const confirmedTableNumber = customerDetails.tableNumber;
                showConfirmationScreen(confirmedTableNumber);
            } else {
                showErrorScreen(errorMessage);
            }
        }

        async function fetchWithRetry(url, options, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response;
                    }
                } catch (error) {
                    console.warn(`Attempt ${i + 1} failed: ${error.message}`);
                }

                if (i < maxRetries - 1) {
                    const delay = Math.pow(2, i) * 1000; 
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            throw new Error("All fetch attempts failed.");
        }


        function showConfirmationScreen(tableNumber) {
            cart = {};
            customerDetails = { name: '', contact: '', tableNumber: '', instructions: '' };
            currentCategory = 'Starter';

            const html = `
                <div class="flex-grow flex flex-col justify-center items-center p-8 text-center">
                    <svg class="w-24 h-24 text-green-500 mx-auto mb-4" 
                            style="animation: bounce-in 0.5s ease-out 1;"
                            fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    
                    <h1 class="text-4xl font-extrabold text-green-600 mt-2 font-['Poppins']">Order Confirmed!</h1>
                    <p class="text-xl text-gray-700 mt-2 mb-8 font-['Poppins']">
                        Successfully Placed for Table #${tableNumber}.
                    </p>
                    <div class="bg-yellow-100 text-yellow-800 p-3 rounded-xl max-w-xs mb-8 text-sm">
                        The kitchen is preparing your delicious meal now.
                    </div>
                    <button onclick="showWelcomeScreen()" class="py-3 px-8 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-full shadow-lg transform transition duration-150 font-['Poppins']">
                        Start New Order
                    </button>
                </div>
            `;
            renderScreen(html);
        }

        function showErrorScreen(message) {
            const html = `
                <div class="flex-grow flex flex-col justify-center items-center p-8 text-center">
                    <svg class="w-20 h-20 text-red-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <h1 class="text-3xl font-extrabold text-red-600 mt-2 font-['Poppins']">Order Failed</h1>
                    <p class="text-md text-gray-700 mt-4 mb-6">
                        There was an issue processing your order. Please try again.
                    </p>
                    <p class="text-sm text-gray-500 mb-8 max-w-xs">${message}</p>

                    <button onclick="showDetailsScreen()" class="py-3 px-8 bg-red-600 hover:bg-red-700 text-white font-bold rounded-full shadow-lg transform transition duration-150 font-['Poppins']">
                        Go Back and Retry
                    </button>
                </div>
            `;
            renderScreen(html);
        }

        window.onload = showWelcomeScreen;

    </script>
</body>
</html>
